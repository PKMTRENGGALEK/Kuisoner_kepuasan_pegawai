<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Lihat Data Kepuasan Pegawai</title>

    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- DataTables -->
    <link
      href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"
      rel="stylesheet"
    />
    <!-- <link
      href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"
      rel="stylesheet"
    /> -->

    <style>
      body {
        background-color: #fcfff9;
        font-family: "Poppins", sans-serif;
        font-size: 13px;
      }
      h3 {
        color: #718a49;
        font-weight: 700;
      }
      table.dataTable thead {
        background: linear-gradient(135deg, #718a49, #e8eedf);
        color: #fff;
        text-align: center;
      }
      .card {
        border-radius: 14px;
        box-shadow: 0 3px 12px rgba(0, 0, 0, 0.08);
        border: none;
      }
      footer {
        text-align: center;
        margin-top: 20px;
        color: #718a49;
        font-size: 12px;
      }
      .spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 180px;
      }
      .summary-card {
        border-left: 6px solid #718a49;
        background: #f8f8f8;
        transition: 0.3s;
      }
      .summary-title {
        font-weight: bold;
        color: #718a49;
      }
    </style>
  </head>

  <body>
    <div class="container mt-4">
      <div class="text-center mb-3">
        <img
          src="https://pkmtrenggalek.github.io/SIP/assets/pkm.png"
          alt="Logo"
          width="70"
          class="mb-1"
        />
        <h3>Data Rekap Kepuasan Pegawai</h3>
        <p class="text-muted">Puskesmas Trenggalek 2025</p>
      </div>

      <!-- Tombol Unduh -->
      <div class="d-flex justify-content-end mb-3">
        <a
          href="https://docs.google.com/spreadsheets/d/1kKuRteLllZy8I15eAR3Hq7IKZno2aX98iVFsxGg6Vxo/export?format=xlsx"
          class="btn btn-success btn-sm d-flex align-items-center shadow"
          style="gap: 6px"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-download"
            viewBox="0 0 16 16"
          >
            <path
              d="M.5 9.9a.5.5 0 0 1 .5-.5h4.5V1.5a.5.5 0 0 1 1 0v7.9h4.5a.5.5 0 0 1 .354.854l-5 5a.5.5 0 0 1-.708 0l-5-5A.5.5 0 0 1 .5 9.9z"
            />
            <path
              d="M.5 15a.5.5 0 0 1 .5-.5h14a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5z"
            />
          </svg>
          Unduh Excel
        </a>
      </div>

      <div class="card p-3">
        <div id="loading" class="spinner">
          <div class="spinner-border text-danger" role="status">
            <span class="visually-hidden">Memuat...</span>
          </div>
        </div>

        <div class="table-responsive" id="tableContainer" style="display: none">
          <table
            id="dataTable"
            class="table table-striped table-hover align-middle table-sm table-bordered"
          >
            <thead>
              <tr id="tableHead"></tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>

        <!-- Ringkasan -->
        <div id="summary" class="mt-4" style="display: none">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="card summary-card p-3">
                <div class="summary-title">Total Nilai (TN)</div>
                <h5 id="tn" class="mt-2">-</h5>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card summary-card p-3">
                <div class="summary-title">NRR Per Unsur</div>
                <h5 id="nrr" class="mt-2">-</h5>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card summary-card p-3">
                <div class="summary-title">NRR x 0,04</div>
                <h5 id="nrr04" class="mt-2">-</h5>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card summary-card p-3" id="indexCard">
                <div class="summary-title">Index Kepuasan</div>
                <h5 id="index" class="mt-2">-</h5>
                <p id="predikat" class="fw-bold mb-0"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer>¬© 2025 Puskesmas Trenggalek</footer>

    <!-- JS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script> -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <!-- <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script> -->

    <script>
      const SHEET_ID = "1kKuRteLllZy8I15eAR3Hq7IKZno2aX98iVFsxGg6Vxo";
      const SHEET_NAME = "Report";
      const API_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_NAME}`;

      async function ambilData() {
        try {
          const res = await fetch(API_URL);
          const text = await res.text();
          const json = JSON.parse(text.substr(47).slice(0, -2));
          const rows = json.table.rows;

          const rowTN = rows[66];
          const rowNRR = rows[66];
          const rowNRR04 = rows[67];
          const rowIndex = rows[67];

          function sumRange(row, start, end) {
            let total = 0;
            for (let i = start; i <= end; i++) {
              const val = row?.c[i]?.v ? parseFloat(row.c[i].v) : 0;
              total += val;
            }
            return total.toFixed(2);
          }

          const totalTN = sumRange(rowTN, 3, 25);
          const totalNRR = sumRange(rowNRR, 3, 25);
          const totalNRR04 = sumRange(rowNRR04, 3, 25);
          const indexKepuasan = parseFloat(rowIndex?.c[26]?.v) || 0;

          document.getElementById("tn").textContent = totalTN;
          document.getElementById("nrr").textContent = totalNRR;
          document.getElementById("nrr04").textContent = totalNRR04;
          document.getElementById("index").textContent =
            indexKepuasan.toFixed(2);

          // üé® Tentukan predikat & warna gradasi
          const indexCard = document.getElementById("indexCard");
          const predikatText = document.getElementById("predikat");

          let warna = "#fdf1f6";
          let gradien = "linear-gradient(135deg, #fdf1f6, #f8a5c2)";
          let predikat = "Tidak Ada Data";

          if (indexKepuasan >= 3.25) {
            predikat = "Sangat Baik";
            gradien = "linear-gradient(135deg, #a8e063, #56ab2f)";
          } else if (indexKepuasan >= 2.51) {
            predikat = "Baik";
            gradien = "linear-gradient(135deg, #89f7fe, #66a6ff)";
          } else if (indexKepuasan >= 1.76) {
            predikat = "Cukup";
            gradien = "linear-gradient(135deg, #fddb92, #d1fdff)";
          } else if (indexKepuasan > 0) {
            predikat = "Kurang";
            gradien = "linear-gradient(135deg, #f5576c, #f093fb)";
          }

          indexCard.style.background = gradien;
          predikatText.textContent = predikat;

          // üî¢ Tabel data responden
          const filteredRows = rows.filter((r) => {
            const firstCell = r.c[0]?.v
              ? r.c[0].v.toString().toLowerCase()
              : "";
            return (
              firstCell &&
              !firstCell.includes("total") &&
              !firstCell.includes("rata") &&
              !firstCell.includes("index") &&
              !firstCell.includes("jumlah")
            );
          });

          const headers = [
            "No",
            "Nama",
            "Tempat Kerja",
            ...Array.from({ length: 23 }, (_, i) => `U${i + 1}`),
            "Kritik",
            "Saran",
          ];

          document.getElementById("tableHead").innerHTML = headers
            .map((h) => `<th>${h}</th>`)
            .join("");

          let no = 1;
          document.getElementById("tableBody").innerHTML = filteredRows
            .map((r) => {
              const data = r.c.map((c) => (c ? c.v : ""));
              if (!data[1]) return "";
              return `
                <tr>
                  <td>${no++}</td>
                  ${data
                    .slice(1)
                    .map((d) => `<td>${d}</td>`)
                    .join("")}
                </tr>`;
            })
            .join("");

          document.getElementById("loading").style.display = "none";
          document.getElementById("tableContainer").style.display = "block";
          document.getElementById("summary").style.display = "block";

          $("#dataTable").DataTable({
            pageLength: 10,
            dom:
              "<'row mb-1'<'col-sm-6'l><'col-sm-6 text-end'B>>" +
              "<'row'<'col-sm-12'tr>>" +
              "<'row mt-1'<'col-sm-5'i><'col-sm-7'p>>",
          });
        } catch (e) {
          document.getElementById("loading").innerHTML =
            "<p class='text-danger text-center'>‚ùå Gagal mengambil data. Pastikan spreadsheet disetel publik.</p>";
        }
      }

      ambilData();
    </script>
  </body>
</html>
